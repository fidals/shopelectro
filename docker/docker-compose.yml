version: "2"

services:
  se_prod:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: fidals/se
    restart: always
    container_name: se_prod
    environment:
      - DJANGO_SETTINGS_MODULE=shopelectro.settings.prod
      - DATABASE_URL=postgres://postgres:$DB_PASS@se_db_prod/se_prod
      - BROCKER_URL=amqp://$RABBITMQ_DEFAULT_USER:$RABBITMQ_DEFAULT_PASS@se_rabbitmq:5672/
      - REDIS_PASSWORD=$REDIS_PASSWORD
      - REDIS_LOCATION_DEFAULT=redis://se_redis:6379/0
      - REDIS_LOCATION_SESSION=redis://se_redis:6379/1
      - REDIS_LOCATION_THUMBNAIL=redis://se_redis:6379/2
      - REDIS_LOCATION_USER_AGENT=redis://se_redis:6379/3
      - FTP_USER=$FTP_USER
      - FTP_PASS=$FTP_PASS
      - FTP_IP=$FTP_IP
      - SECRET_KEY=$SECRET_KEY
      - YANDEX_SHOP_PASS=$YANDEX_SHOP_PASS
      - EMAIL_HOST_PASSWORD=$EMAIL_HOST_PASSWORD
    entrypoint:
      - circusd
      - /etc/circus/se_prod.ini
    ports:
      - "8010:80"
    links:
      - se_db_prod
      - se_rabbitmq
      - se_redis
    depends_on:  # can't be inherited
      - se_db_prod
    volumes:  # TODO - divide volumes on dev/ and prod/
      - /opt/media/shopelectro:/opt/shopelectro/app/media

  se_dev:
    image: fidals/se
    container_name: se_dev
    environment:
      - DJANGO_SETTINGS_MODULE=shopelectro.settings.dev
      - DATABASE_URL=postgres://postgres:$DB_PASS@se_db_dev/se_dev
      - BROCKER_URL=amqp://$RABBITMQ_DEFAULT_USER:$RABBITMQ_DEFAULT_PASS@se_rabbitmq:5672/
      - FTP_USER=$FTP_USER
      - FTP_PASS=$FTP_PASS
      - FTP_IP=$FTP_IP
      - SECRET_KEY=$SECRET_KEY
      - YANDEX_SHOP_PASS=$YANDEX_SHOP_PASS
      - EMAIL_HOST_PASSWORD=$EMAIL_HOST_PASSWORD
    entrypoint:
      - circusd
      - /etc/circus/se_dev.ini
    ports:
      - "8011:80"
    links:
      - se_db_dev
    depends_on:  # can't be inherited
      - se_db_dev
    volumes:  # TODO - divide volumes on dev/ and prod/
      - /opt/media/shopelectro:/opt/shopelectro/app/media

  se_db_prod:
    image: postgres:9.5
    container_name: se_db_prod
    restart: always
    environment:
      - POSTGRES_DB=se_prod
      - POSTGRES_PASSWORD=$DB_PASS
    volumes:
      - /var/lib/postgresql/data

  se_db_dev:
    image: postgres:9.5
    container_name: se_db_dev
    restart: always
    environment:
      - POSTGRES_DB=se_dev
      - POSTGRES_PASSWORD=$DB_PASS
    volumes:
      - /var/lib/postgresql/data

  se_redis:
    image: redis:alpine
    container_name: se_redis
    restart: always
    command: redis-server --requirepass $REDIS_PASSWORD
    ports:
      - "6380:6379"

  se_rabbitmq:
    image: rabbitmq:management-alpine
    container_name: se_rabbitmq
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER=$RABBITMQ_DEFAULT_USER
      - RABBITMQ_DEFAULT_PASS=$RABBITMQ_DEFAULT_PASS
    ports:
      - "5673:5672"
      - "15673:15672"
